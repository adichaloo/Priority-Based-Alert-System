<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta content="ugh, hi." name="description">
        <meta content="Makeup Webcam" name="title">
        <title>Webcam Streaming</title>
	
	<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>	
	
        <style>
         #container {
             margin: 0px auto;
             border: 10px #333 solid;
         }
         #videoElement {
             width: 640px;
             height: 480px;
             background-color: #666;
         }

         #imageElement {
             width: 640px;
             height: 480px;
             background-color: #666;
         }

         #canvasElement {
             width: 640px;
             height: 480px;
             /*display: none;*/
         }
        </style>
    </head>
    <body>
        <div id="container">
            <video autoplay="true" id="videoElement"></video>
            <br>
            <img id="imageElement" src="">
            <canvas id="canvasElement"></canvas>
        </div>

	<script>
	

	let namespace = "/videoStream";
	let video = document.querySelector("#videoElement");
	let canvas = document.querySelector("#canvasElement");
	let ctx = canvas.getContext('2d');
	let image = document.getElementById('imageElement')
	canvas.width = 640;
	canvas.height = 480;

	var localMediaStream = null;	
	let urlObject
	
	var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace,{reconnect: true});

	function sendSnapshot() {
		if (!localMediaStream) {
			return;
		}
		ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
		console.log(socket.connected)
		if(socket.connected){			
			let dataURL = canvas.toDataURL('image/png');		
			socket.emit('inputImage', dataURL);
			console.log("Frame Sent!")}
		else{
			console.log("Socket Not Connected")
		}
	}

	socket.on('connect', function() {
	    console.log('Connected to Server!');

		socket.on('processedVideo',function(arrayBuffer){
			
			let base64String = String.fromCharCode(...new Uint8Array(arrayBuffer));
			//console.log("Data Received From Server: ",base64String)
			image.src = 'data:image/PNG;base64,'+base64String;
		})

		socket.on("disconnect",function(){
			console.log("Socket Disconnected")
		})

		var constraints = {
			video: {
			  width: { min: 640 },
			  height: { min: 480 }
			}
		};

		navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
			video.srcObject = stream;
			localMediaStream = stream;

			setInterval(function () {
			  sendSnapshot();
			}, 1000);
		  }).catch(function(error) {
			console.log(error);
		});
		});



	</script>
	<script src="/static/assets/js/app.js"></script>
    </body>
</html>
